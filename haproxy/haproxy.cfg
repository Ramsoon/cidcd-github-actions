global
    daemon
    maxconn 4000
    log 127.0.0.1 local0 info

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option forwardfor
    option httplog
    log global

frontend http_front
    bind *:80
    stats uri /haproxy?stats
    stats refresh 30s
    stats auth admin:admin123
    
    # Route API calls to backend
    acl is_api path_beg /api
    use_backend api_back if is_api
    
    # Default to frontend
    default_backend http_back

backend http_back
    balance roundrobin
    option httpchk GET / HTTP/1.1\r\nHost:localhost
    server frontend1 frontend-service:80 check inter 10s fall 3 rise 2
    server frontend2 frontend-service:80 check inter 10s fall 3 rise 2
    server frontend3 frontend-service:80 check inter 10s fall 3 rise 2

backend api_back
    balance roundrobin
    option httpchk GET /api/health HTTP/1.1\r\nHost:localhost
    server backend1 backend-service:5000 check inter 10s fall 3 rise 2
    server backend2 backend-service:5000 check inter 10s fall 3 rise 2
    server backend3 backend-service:5000 check inter 10s fall 3 rise 2

listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats auth admin:admin123